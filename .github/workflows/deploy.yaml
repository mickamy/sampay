name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - stg
          - prod
  push:
    tags:
      - "v*"

concurrency:
  group: deploy-${{ inputs.environment || 'prod' }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1

jobs:
  resolve-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.resolve.outputs.environment }}
    steps:
      - name: Resolve environment
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "environment=prod" >> "$GITHUB_OUTPUT"
          else
            echo "environment=${{ inputs.environment }}" >> "$GITHUB_OUTPUT"
          fi

  build-and-push:
    needs: resolve-env
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.resolve-env.outputs.environment }}

    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      ecr_backend_url: ${{ steps.meta.outputs.ecr_backend_url }}
      ecr_frontend_url: ${{ steps.meta.outputs.ecr_frontend_url }}

    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          ENV=${{ needs.resolve-env.outputs.environment }}
          PREFIX="sampay-${ENV}"
          REGISTRY=${{ steps.ecr-login.outputs.registry }}
          TAG="${GITHUB_SHA::8}"

          echo "image_tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "ecr_backend_url=${REGISTRY}/${PREFIX}/backend" >> "$GITHUB_OUTPUT"
          echo "ecr_frontend_url=${REGISTRY}/${PREFIX}/frontend" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.ecr_backend_url }}:${{ steps.meta.outputs.image_tag }}
          build-args: |
            MAIN_GO_FILE=./cmd/api/main.go
          platforms: linux/arm64
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta.outputs.ecr_frontend_url }}:${{ steps.meta.outputs.image_tag }}
          platforms: linux/arm64
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      - name: Build and push worker
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.ecr_backend_url }}:worker-${{ steps.meta.outputs.image_tag }}
          build-args: |
            MAIN_GO_FILE=./cmd/worker/main.go
          platforms: linux/arm64
          cache-from: type=gha,scope=worker
          cache-to: type=gha,mode=max,scope=worker

      - name: Build and push migration
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile.migration
          push: true
          tags: ${{ steps.meta.outputs.ecr_backend_url }}:migration-${{ steps.meta.outputs.image_tag }}
          platforms: linux/arm64
          cache-from: type=gha,scope=migration
          cache-to: type=gha,mode=max,scope=migration

  deploy:
    needs: [resolve-env, build-and-push]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: ${{ needs.resolve-env.outputs.environment }}

    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Open SSH access in Security Group
        id: sg
        run: |
          RUNNER_IP=$(curl -s https://checkip.amazonaws.com)
          echo "runner_ip=${RUNNER_IP}" >> "$GITHUB_OUTPUT"
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.EC2_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${RUNNER_IP}/32"

      - name: Copy compose file to EC2
        uses: appleboy/scp-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "compose.prod.yaml"
          target: "/app/"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            ENV=${{ needs.resolve-env.outputs.environment }}
            case "$ENV" in
              prod) APP_ENV=production ;;
              stg)  APP_ENV=staging ;;
              *)    APP_ENV="$ENV" ;;
            esac

            # Write .env.compose with orchestration vars
            cat > /app/.env.compose << EOF
            APP_ENV=${APP_ENV}
            ECR_BACKEND_URL=${{ needs.build-and-push.outputs.ecr_backend_url }}
            ECR_FRONTEND_URL=${{ needs.build-and-push.outputs.ecr_frontend_url }}
            IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}
            SM_PREFIX=sampay-${ENV}
            SM_APP_SECRET=sampay-${ENV}/app
            SM_DB_SECRET=sampay-${ENV}/db
            SM_KVS_SECRET=sampay-${ENV}/kvs
            EOF

            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
              docker login --username AWS --password-stdin ${{ needs.build-and-push.outputs.ecr_backend_url }}

            # Pull new images (app + migration)
            cd /app
            docker compose --env-file .env.compose -f compose.prod.yaml pull api web worker
            docker pull ${{ needs.build-and-push.outputs.ecr_backend_url }}:migration-${{ needs.build-and-push.outputs.image_tag }}

            # Restart services (pull-secrets.sh runs via ExecStartPre)
            sudo systemctl restart sampay || true

            # Poll for all containers to be healthy (up to 90s)
            echo "Waiting for services to be healthy..."
            for i in $(seq 1 18); do
              UNHEALTHY=$(docker compose --env-file .env.compose -f compose.prod.yaml ps --format json | jq -r 'select(.State != "running" or (.Health != null and .Health != "healthy")) | .Name' 2>/dev/null)
              if [ -z "$UNHEALTHY" ]; then
                echo "All containers are healthy"
                docker compose --env-file .env.compose -f compose.prod.yaml ps
                exit 0
              fi
              echo "Waiting... ($i/18) unhealthy: $UNHEALTHY"
              sleep 5
            done
            echo "ERROR: Containers not healthy after 90s"
            docker compose --env-file .env.compose -f compose.prod.yaml ps
            exit 1

      - name: Revoke SSH access from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.EC2_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.sg.outputs.runner_ip }}/32" 2>/dev/null || true
