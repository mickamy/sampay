name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - stg
          - prod
  push:
    tags:
      - "v*"

concurrency:
  group: deploy-${{ inputs.environment || 'prod' }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1

jobs:
  resolve-env:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.resolve.outputs.environment }}
    steps:
      - name: Resolve environment
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "environment=prod" >> "$GITHUB_OUTPUT"
          else
            echo "environment=${{ inputs.environment }}" >> "$GITHUB_OUTPUT"
          fi

  build-and-push:
    needs: resolve-env
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: ${{ needs.resolve-env.outputs.environment }}

    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      ecr_backend_url: ${{ steps.meta.outputs.ecr_backend_url }}
      ecr_frontend_url: ${{ steps.meta.outputs.ecr_frontend_url }}

    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set image metadata
        id: meta
        run: |
          ENV=${{ needs.resolve-env.outputs.environment }}
          PREFIX="sampay-${ENV}"
          REGISTRY=${{ steps.ecr-login.outputs.registry }}
          TAG="${GITHUB_SHA::8}"

          echo "image_tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "ecr_backend_url=${REGISTRY}/${PREFIX}/backend" >> "$GITHUB_OUTPUT"
          echo "ecr_frontend_url=${REGISTRY}/${PREFIX}/frontend" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.ecr_backend_url }}:${{ steps.meta.outputs.image_tag }}
          build-args: |
            MAIN_GO_FILE=./cmd/api/main.go
          platforms: linux/arm64
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          push: true
          tags: ${{ steps.meta.outputs.ecr_frontend_url }}:${{ steps.meta.outputs.image_tag }}
          platforms: linux/arm64
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      - name: Build and push migration
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile.migration
          push: true
          tags: ${{ steps.meta.outputs.ecr_backend_url }}:migration-${{ steps.meta.outputs.image_tag }}
          platforms: linux/arm64
          cache-from: type=gha,scope=migration
          cache-to: type=gha,mode=max,scope=migration

  deploy:
    needs: [resolve-env, build-and-push]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    environment: ${{ needs.resolve-env.outputs.environment }}

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v6
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Open SSH access in Security Group
        id: sg
        run: |
          RUNNER_IP=$(curl -s https://checkip.amazonaws.com)
          echo "runner_ip=${RUNNER_IP}" >> "$GITHUB_OUTPUT"
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.EC2_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${RUNNER_IP}/32"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | \
              docker login --username AWS --password-stdin ${{ needs.build-and-push.outputs.ecr_backend_url }}

            # Update .env.compose with new image tag
            cd /app
            sed -i 's/^IMAGE_TAG=.*/IMAGE_TAG=${{ needs.build-and-push.outputs.image_tag }}/' .env.compose

            # Pull new images (app + migration)
            docker compose -f compose.prod.yaml pull api web
            docker pull ${{ needs.build-and-push.outputs.ecr_backend_url }}:migration-${{ needs.build-and-push.outputs.image_tag }}

            # Restart services (pull-secrets.sh runs via ExecStartPre)
            sudo systemctl restart sampay

            # Wait for health checks
            echo "Waiting for services to be healthy..."
            sleep 10
            docker compose -f compose.prod.yaml ps

      - name: Verify deployment
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: deploy
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Check all containers are running and healthy
            UNHEALTHY=$(docker compose -f /app/compose.prod.yaml ps --format json | jq -r 'select(.State != "running" or (.Health != null and .Health != "healthy")) | .Name' 2>/dev/null)
            if [ -n "$UNHEALTHY" ]; then
              echo "ERROR: Unhealthy or not running containers detected: $UNHEALTHY"
              docker compose -f /app/compose.prod.yaml logs --tail=50
              exit 1
            fi
            echo "All containers are running and healthy"

      - name: Revoke SSH access from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.EC2_SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.sg.outputs.runner_ip }}/32" 2>/dev/null || true
